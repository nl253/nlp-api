default:
  image: ubuntu:latest

Test:
  stage: test
  only:
    changes:
      - '*/app.js'
      - '*/event.json'
      - '*/package.json'
      - '*/tests/unit/*.test.js'
  script:
    - |
      export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
      export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
      apt update
      apt install -y curl
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm install 12
      nvm use 12
      for i in *; do
        if [[ -f ./$i/tests/unit/app.test.js ]]; then
          cd ./$i
          npm install
          npm test || exit 1
          rm -r -f node_modules
          cd ..
        fi
      done

BuildAndDeploy:
  stage: deploy
  image: python:3.8
  only:
    refs:
      - develop
    changes:
      - '*/app.js'
      - '*/package.json'
      - '*.json'
      - '*.yml'
      - '*.yaml'
  artifacts:
    paths:
      - .aws-sam/build
  needs:
    - Test
  before_script:
    - pip3 install awscli --upgrade
    - pip3 install aws-sam-cli --upgrade
  script:
    - sam build
    - sam package
    - sam deploy
