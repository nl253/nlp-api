default:
  image: ubuntu:latest

Test:
  interruptible: true
  stage: test
  cache:
    paths:
      - '*/node_modules'
  only:
    changes:
      - '*/app.js'
      - '*/event.json'
      - '*/package.json'
      - '*/tests/unit/*.test.js'
  script:
    - |
      export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
      export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
      apt update
      apt install -y curl
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm install 12
      nvm use 12
      for i in *; do
        if [[ -f ./$i/tests/unit/app.test.js ]]; then
          cd ./$i
          npm install
          npm test || exit 1
          cd ..
        fi
      done

BuildAndDeploy:
  interruptible: true
  stage: deploy
  image: python:3.8
  only:
    refs:
      - develop
    changes:
      - '*/app.js'
      - '*/package.json'
      - template.yaml
      - samconfig.toml
  artifacts:
    paths:
      - .aws-sam/build
  before_script:
    - pip3 install awscli --upgrade
    - pip3 install aws-sam-cli --upgrade
  script:
    - |
      apt update
      apt install -y curl
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm install 12
      nvm use 12
      sam build
      sam package --s3-prefix nlp-api-dev --s3-bucket codebuild-nl
      sam deploy --no-confirm-changeset
